---
title: "Case_Study_Group_50"
author: "Long Hong, Vanessa Schwarz, Jonas Rieger, Andre Düding, Brian Eiffert"
date: "16 7 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

# Introduction

The intention of this project is to find the faulty vehicles, which are of the type "Type11" and "Type12". A diesel engine "K1DI1" has been installed on these vehicles. The defective vehicles were produced from 1 March 2008 to 11 March 2012.  The recall action will start where the first diesel bans come into force. As starting point the Hamburg area is chosen, because there the first bans will be introduced. 

# Packages
Install required packages

```{r}
if(!require("install.load")){
  install.packages("install.load")
}
library(install.load)

install_load("readr", "tidyverse", "stringr", "readxl","ggplot2", "plotly","lubridate", "data.table","bit64","tm","geosphere","sp")
```


# Import Data

## Choice of relevant data
The task is to find all relevant type 11 and type 12 vehicles from OEM1 that were produced during the problematic period. In addition, the suitable engine "K1DI1" must find.
```{r}
# data_bestandteile_oem1_typ11/12, data_fahrzeug_OEM1_typ11/12, data_Komponente_K1DI1

#OEM Typ 11/12
data_bestandteile_oem1_typ11 <- read_csv2("./Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ11.csv", col_types = cols(X1=col_integer(),ID_Karosserie=col_character(),ID_Schaltung=col_character(),ID_Sitze=col_character(),ID_Motor=col_character(),ID_Fahrzeug=col_character())) # Import data
data_bestandteile_oem1_typ11$X1<- NULL # Delete unecessary column

data_bestandteile_oem1_typ12 <- read_csv2("./Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ12.csv", col_types = cols(X1=col_integer(),ID_Karosserie=col_character(),ID_Schaltung=col_character(),ID_Sitze=col_character(),ID_Motor=col_character(),ID_Fahrzeug=col_character())) # Import data
data_bestandteile_oem1_typ12$X1<- NULL # Delete unecessary column

# Fahrzeuf OEM TTyp 11/12 
data_fahrzeug_OEM1_Typ11 <- read_csv("./Data/Fahrzeug/Fahrzeuge_OEM1_Typ11.csv", col_types = cols(X1= col_integer(),ID_Fahrzeug=col_character(),Produktionsdatum= col_character(),Herstellnumer= col_integer(), Fehlerhaft=col_skip(), Fehlerhaft_Datum=col_character(), Fehlerhaft_Fahrleistung=col_integer()))# Import data

data_fahrzeug_OEM1_Typ11 <- data_fahrzeug_OEM1_Typ11[,c(-1,-2)]# Delete unecessary column
data_fahrzeug_OEM1_Typ11$Produktionsdatum <- as.Date(data_fahrzeug_OEM1_Typ11$Produktionsdatum,
                                                     format = "%Y-%m-%d")# Transform col as date
data_fahrzeug_OEM1_Typ11$Fehlerhaft_Datum <- as.Date(data_fahrzeug_OEM1_Typ11$Fehlerhaft_Datum,
                                                     format = "%Y-%m-%d")# Transform col as date


data_fahrzeug_OEM1_Typ12 <- read_csv("./Data/Fahrzeug/Fahrzeuge_OEM1_Typ11.csv",col_types = cols(X1= col_integer(),ID_Fahrzeug=col_character(),Produktionsdatum= col_character(),Herstellnumer= col_integer(), Fehlerhaft=col_skip(), Fehlerhaft_Datum=col_character(), Fehlerhaft_Fahrleistung=col_integer()))# Import data

data_fahrzeug_OEM1_Typ12 <- data_fahrzeug_OEM1_Typ12[,c(-1,-2)]# Delete unecessary column
data_fahrzeug_OEM1_Typ12$Produktionsdatum <- as.Date(data_fahrzeug_OEM1_Typ12$Produktionsdatum,
                                                     format = "%Y-%m-%d") # Transform col as date
data_fahrzeug_OEM1_Typ12$Fehlerhaft_Datum <- as.Date(data_fahrzeug_OEM1_Typ12$Fehlerhaft_Datum,
                                                     format = "%Y-%m-%d") # Transform col as date



# Ort und Zulassung
data_bundesland_plz_ort <- read_excel("./Data/Zulassungen/OpenGeoDB_bundesland_plz_ort_de (1).xls", col_names = c("Bundesland","PLZ","Ort"))%>%
  add_row(Bundesland="Bayern",PLZ="87637",Ort="Seeg")
data_bundesland_plz_ort$Ort <- removeNumbers(data_bundesland_plz_ort$Ort)#https://stackoverflow.com/questions/13590139/remove-numbers-from-alphanumeric-characters
#Problem mit Länge der PLZ bei Transformation zu integer (see "Leading Zeros") bei Sachsen
#data_bundesland_plz_ort$PLZ <- as.integer(data_bundesland_plz_ort$PLZ)

data_Zulassung <- read_csv2("./Data/Zulassungen/Zulassungen_alle_Fahrzeuge.csv")%>%
  rename(Ort=Gemeinden)
data_Zulassung$Ort <- str_to_title(data_Zulassung$Ort) # Pipe-operator with mutate doesn't work
data_Zulassung$Ort <- removeNumbers(data_Zulassung$Ort) # Remove unecessary numbers in location
data_Zulassung$X1 <- NULL # Remove unecessary column

data_Geodaten_Gemeinden <- read_csv2("./Data/Geodaten/Geodaten_Gemeinden_v1.2_2017-08-22_TrR.csv",col_types =                                    cols(Postleitzahl=col_character(),Laengengrad=col_double(),Breitengrad=col_double()))%>%
  rename(Ort=Gemeinde,PLZ= Postleitzahl)%>%
  add_row(PLZ="87637",Ort="Seeg",Laengengrad=10.6104157,Breitengrad=47.6542215)
# Add missing Zeros to PLZ length under 5, for more info see https://stackoverflow.com/questions/5812493/how-to-add-leading-zeros
data_Geodaten_Gemeinden$PLZ <- str_pad(data_Geodaten_Gemeinden$PLZ,5,pad = "0") 
data_Geodaten_Gemeinden$Ort <- removeNumbers(data_Geodaten_Gemeinden$Ort)
data_Geodaten_Gemeinden$Ort <- str_to_title(data_Geodaten_Gemeinden$Ort)
data_Geodaten_Gemeinden <- data_Geodaten_Gemeinden[,c(-1,-2)] # Remove unecessary column

```

# Tidy Data
Now the data have to be tidy up
```{r}

new_data_bestandteile_oem1_typ11 <- data_bestandteile_oem1_typ11 %>%
  filter(grepl("K1DI1",ID_Motor,fixed=TRUE))%>% # Filter after the relevant motor for more information : https://www.rdocumentation.org/packages/dplyr/versions/0.7.8/topics/filter
  select(ID_Motor,ID_Fahrzeug) #Select relevant coulums
  

new_data_bestandteile_oem1_typ12 <- new_data_bestandteile_oem1_typ11 %>%
  filter(grepl("K1DI1",ID_Motor,fixed=TRUE))%>% # Filter for relevant motor 
  select(ID_Motor,ID_Fahrzeug)# select necessary columns

new_data_fahrzeug_OEM1_Typ11 <- data_fahrzeug_OEM1_Typ11 %>%
  select(ID_Fahrzeug,Produktionsdatum)%>% # select relevant columns
  filter(between(Produktionsdatum, as.Date("2008-03-01"),
                                  as.Date("2012-05-11")))# Filter after the relevant time period for more information: https://stackoverflow.com/questions/28335715/r-how-to-filter-subset-a-sequence-of-dates
  

new_data_fahrzeug_OEM1_Typ12 <- data_fahrzeug_OEM1_Typ12 %>%
  select(ID_Fahrzeug,Produktionsdatum)%>% # select necessary columns
  filter(between(Produktionsdatum, as.Date("2008-03-01"), #Filter for relevant timeperiod
                                  as.Date("2012-05-11")))

# Tidy data_Zulassung
new_data_Zulassung <- data_Zulassung %>%
  rename(ID_Fahrzeug=IDNummer)%>% # Rename column for consistency
  select(ID_Fahrzeug,Ort,Zulassung)%>% # Select relevant columns
  mutate(ID_Fahrzeug_Nummer = as.integer64(str_replace_all(ID_Fahrzeug,"-",""))) # Add ID_Fahrzueg as integer column for further calculations

```
# Creaing one Data set
```{r}
#Summarise datatset bestandteile from oem1 Typ 11/12
data_bestandteile_OEM1 <- bind_rows(new_data_bestandteile_oem1_typ11, 
                                    new_data_bestandteile_oem1_typ12)%>% # Get one date set from Type 11 and type 12
  mutate(ID_Fahrzeug_Nummer= as.integer64(str_replace_all(ID_Fahrzeug,"-","")))# Get integer value for later join

#Summarise datatset Fahrzeug from oem1 Typ 11/12
data_fahrzeug_OEM1 <- bind_rows(new_data_fahrzeug_OEM1_Typ11,
                                new_data_fahrzeug_OEM1_Typ12)%>% # Get one date set from Type 11 and type 12
  mutate(ID_Fahrzeug_Nummer= as.integer64(str_replace_all(ID_Fahrzeug,"-","")))# Get integer value for later join    

# One data set for OEM
data_OEM <- left_join(data_fahrzeug_OEM1,data_bestandteile_OEM1,
                       by="ID_Fahrzeug_Nummer",na_matches="never")%>%# Get Dataset to get engine and production date. Dealing with NA see: https://stackoverflow.com/questions/58454706/how-do-i-fix-error-stdbad-alloc-message-when-using-dplyr-full-join-to-join-3
            rename(ID_Fahrzeug = ID_Fahrzeug.x)
data_OEM <- data_OEM[!is.na(data_OEM$ID_Motor),]
  
data_OEM$ID_Fahrzeug.y <- NULL

# Left or Right Join ????
# One data set for location
data_Ort2 <- left_join(data_Geodaten_Gemeinden,data_bundesland_plz_ort, by="PLZ")%>%
  rename(Ort=Ort.x)%>%
  distinct(Ort, .keep_all=TRUE)
data_Ort2$Ort.y <- NULL

#Calculate distance from Hamburg for every City
dist<-c()
data_Ort2_matrix <- data_Ort2 %>%
  select(Laengengrad, Breitengrad)%>%
  data.matrix()
for (i in 1:nrow(data_Ort2)){
   calc <- round(as.integer(distm(c(data_Ort2_matrix[i,1],data_Ort2_matrix[i,2]),c(9.993682,53.551085),fun=distGeo)),
                 digits=0)
   #https://cran.r-project.org/web/packages/geosphere/geosphere.pdf
   dist[i]<-calc   
}


#Cbinding distance calculation to the data_Ort2 Dataframe 
data_Ort2<-cbind(data_Ort2,dist)


data_Ort <- left_join(new_data_Zulassung,data_Ort2, by="Ort")

# get final dataset by joining location and OEM data set
final_data_Group_50 <- left_join(data_OEM,data_Ort,by="ID_Fahrzeug_Nummer")%>%# Joining cars with Zulassung
  rename(ID_Fahrzeug = ID_Fahrzeug.x)
final_data_Group_50$ID_Fahrzeug.y <- NULL
final_data_Group_50$ID_Fahrzeug_Nummer <- NULL

#saving dataset final_data_Group_50
save(final_data_Group_50, file="final_data_Group_50.Rda")
```

