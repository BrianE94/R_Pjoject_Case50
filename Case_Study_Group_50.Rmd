---
title: "Case_Study_Group_50"
author: "Long Hong, Vanessa Schwarz, Jonas Rieger, Andre D체ding, Brian Eiffert"
date: "16 7 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


# Packages
Install required packages

```{r}
if(!require("install.load")){
  install.packages("install.load")
}
library(install.load)

install_load("readr", "tidyverse", "stringr", "readxl","ggplot2", "plotly","lubridate", "data.table","bit64","tm")
```
#Functions
```{r}
ID_to_number <- function(data,ID){
  F1 <-  separate(data,ID,sep = "-", into = c("v1","v2","v3","v4"))
  a= toString(ID)+"_Number"
  F2 <-  unite(F1, v1,v2,v3,v4,col= a,sep="")

  data_bestandteile_OEM1 <- add_column(data_bestandteile_OEM1,F2$ID_Fahrzeug_Nummer)%>%
    rename(ID_Fahrzeug_Nummer=F2$ID_Fahrzeug_Nummer)
}


```

# Import Data
Fist the necessary documents have to be imported in the R Markdown file.
```{r}
# data_bestandteile_oem1_typ11/12, data_fahrzeug_OEM1_typ11/12, data_Komponente_K1DI1

#OEM Typ 11/12
data_bestandteile_oem1_typ11 <- read_csv2("./Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ11.csv", col_types = cols(X1=col_integer(),ID_Karosserie=col_character(),ID_Schaltung=col_character(),ID_Sitze=col_character(),ID_Motor=col_character(),ID_Fahrzeug=col_character())) # Import data
data_bestandteile_oem1_typ11$X1<- NULL # Delete unecessary column

data_bestandteile_oem1_typ12 <- read_csv2("./Data/Fahrzeug/Bestandteile_Fahrzeuge_OEM1_Typ12.csv", col_types = cols(X1=col_integer(),ID_Karosserie=col_character(),ID_Schaltung=col_character(),ID_Sitze=col_character(),ID_Motor=col_character(),ID_Fahrzeug=col_character())) # Import data
data_bestandteile_oem1_typ12$X1<- NULL # Delete unecessary column

# Fahrzeuf OEM TTyp 11/12 
data_fahrzeug_OEM1_Typ11 <- read_csv("./Data/Fahrzeug/Fahrzeuge_OEM1_Typ11.csv", col_types = cols(X1= col_integer(),ID_Fahrzeug=col_character(),Produktionsdatum= col_character(),Herstellnumer= col_integer(), Fehlerhaft=col_skip(), Fehlerhaft_Datum=col_character(), Fehlerhaft_Fahrleistung=col_integer()))# Import data

data_fahrzeug_OEM1_Typ11 <- data_fahrzeug_OEM1_Typ11[,c(-1,-2)]# Delete unecessary column
data_fahrzeug_OEM1_Typ11$Produktionsdatum <- as.Date(data_fahrzeug_OEM1_Typ11$Produktionsdatum,
                                                     format = "%Y-%m-%d")# Transform col as date
data_fahrzeug_OEM1_Typ11$Fehlerhaft_Datum <- as.Date(data_fahrzeug_OEM1_Typ11$Fehlerhaft_Datum,
                                                     format = "%Y-%m-%d")# Transform col as date


data_fahrzeug_OEM1_Typ12 <- read_csv("./Data/Fahrzeug/Fahrzeuge_OEM1_Typ11.csv",col_types = cols(X1= col_integer(),ID_Fahrzeug=col_character(),Produktionsdatum= col_character(),Herstellnumer= col_integer(), Fehlerhaft=col_skip(), Fehlerhaft_Datum=col_character(), Fehlerhaft_Fahrleistung=col_integer()))# Import data

data_fahrzeug_OEM1_Typ12 <- data_fahrzeug_OEM1_Typ12[,c(-1,-2)]# Delete unecessary column
data_fahrzeug_OEM1_Typ12$Produktionsdatum <- as.Date(data_fahrzeug_OEM1_Typ12$Produktionsdatum,
                                                     format = "%Y-%m-%d") # Transform col as date
data_fahrzeug_OEM1_Typ12$Fehlerhaft_Datum <- as.Date(data_fahrzeug_OEM1_Typ12$Fehlerhaft_Datum,
                                                     format = "%Y-%m-%d") # Transform col as date



# Ort und Zulassung
data_bundesland_plz_ort <- read_excel("./Data/Zulassungen/OpenGeoDB_bundesland_plz_ort_de (1).xls", col_names = c("Bundesland","PLZ","Ort"))%>%
  add_row(Bundesland="Bayern",PLZ="87637",Ort="Seeg")
data_bundesland_plz_ort$Ort <- removeNumbers(data_bundesland_plz_ort$Ort)#https://stackoverflow.com/questions/13590139/remove-numbers-from-alphanumeric-characters
#Problem mit L채nge der PLZ bei Transformation zu integer (see "Leading Zeros")
#data_bundesland_plz_ort$PLZ <- as.integer(data_bundesland_plz_ort$PLZ)

data_Zulassung <- read_csv2("./Data/Zulassungen/Zulassungen_alle_Fahrzeuge.csv")%>%
  rename(Ort=Gemeinden)
data_Zulassung$Ort <- str_to_title(data_Zulassung$Ort) # Pipe-operator with mutate doesn't work
data_Zulassung$Ort <- removeNumbers(data_Zulassung$Ort)
data_Zulassung$X1 <- NULL

data_Geodaten_Gemeinden <- read_csv2("./Data/Geodaten/Geodaten_Gemeinden_v1.2_2017-08-22_TrR.csv",col_types =                                    cols(Postleitzahl=col_character(),Laengengrad=col_double(),Breitengrad=col_double()))%>%
  rename(Ort=Gemeinde,PLZ= Postleitzahl)%>%
  add_row(PLZ="87637",Ort="Seeg",Laengengrad=10.6104157,Breitengrad=47.6542215)
# Add missing Zeros to PLZ length under 5, for more info see https://stackoverflow.com/questions/5812493/how-to-add-leading-zeros
data_Geodaten_Gemeinden$PLZ <- str_pad(data_Geodaten_Gemeinden$PLZ,5,pad = "0") 
data_Geodaten_Gemeinden$Ort <- removeNumbers(data_Geodaten_Gemeinden$Ort)
data_Geodaten_Gemeinden$Ort <- str_to_title(data_Geodaten_Gemeinden$Ort)
data_Geodaten_Gemeinden <- data_Geodaten_Gemeinden[,c(-1,-2)]

```

```{r}
# F체r die Case Stud nicht relevant

# Bestandteile Mototr K1DI1
data_bestandteile_Komponente_K1DI1 <- read_csv2("./Data/Komponente/Bestandteile_Komponente_K1DI1.csv")# Import data
data_bestandteile_Komponente_K1DI1$X1 <- NULL # Delete unecessary column

#Einzelteile (1,2,5,6) werden Importiert (f체r K1DI1); Siehe Case Study Vorbereitung 
data_einzelteil_t1 <- read_file("./Data/Einzelteil/Einzelteil_T01.txt")%>%
  str_replace_all("[[|]]"," ")%>% #replace all seperators with simicolon 
  str_replace_all("     ", ";")%>%
  str_replace_all(" ","\n")%>%#replace all withespaces with newlines
  fread()
data_einzelteil_t1 <- data_einzelteil_t1, col_type=cols(ID_T05.y=col_character(),Produktionsdatum.y=col_date(format=""),Herstellernummer.y=col_character(),Werksnummer.y=col_character(),  Fehlerhaft.y = col_logical(), Fehlerhaft_Datum.y = col_date(format=""), Fehlerhaft_Fahrleistung.y = col_character())

data_einzelteil_t2 <- read_file("./Data/Einzelteil/Einzelteil_T02.txt")%>%
  str_replace_all("  ",";")%>%
  str_replace_all("\t","\n")%>%
  fread()
data_einzelteil_t2 <- data_einzelteil_t2[,c(-1,-2)]

data_einzelteil_t5 <- read_csv("./Data/Einzelteil/Einzelteil_T05.csv", col_type=cols(ID_T05.y=col_character(),Produktionsdatum.y=col_date(format=""),Herstellernummer.y=col_character(),Werksnummer.y=col_character(),  Fehlerhaft.y = col_logical(), Fehlerhaft_Datum.y = col_date(format=""), Fehlerhaft_Fahrleistung.y = col_character()))
class(data_einzelteil_t5$ID_T05.y)
data_einzelteil_t5 <- data_einzelteil_t5[,c(-1,-2)]

data_einzelteil_t6 <- read_csv("./Data/Einzelteil/Einzelteil_T05.csv",col_type=cols(ID_T05.y=col_character(),Produktionsdatum.y=col_date(format=""),Herstellernummer.y=col_character(),Werksnummer.y=col_character(),  Fehlerhaft.y = col_logical(), Fehlerhaft_Datum.y = col_date(format=""), Fehlerhaft_Fahrleistung.y = col_character()))
data_einzelteil_t6 <- data_einzelteil_t6[,c(-1,-2)]

#Komonenete K1DI1 wahrscheinlich unwichtig

#Komponente K1DI1
data_Komponente_K1DI1 <- read_csv("./Data/Komponente/Komponente_K1DI1.csv", col_type=cols(ID_Motor.y=col_character(), Produktionsdatum.y=col_date(format=""), Herstellernummer.y=col_integer(),Werksnummer.y=col_integer(), Fehlerhaft.y = col_logical(), Fehlerhaft_Datum.y = col_date(format=""), Fehlerhaft_Fahrleistung.y = col_character(),ID_Motor= col_character(),Produktionsdatum=col_date(format=""),Herstellernummer=col_integer(),Werksnummer=col_integer()))# Import data
data_Komponente_K1DI1 <- data_Komponente_K1DI1[,c(-1,-2)] # Delete unecessary column
# Aufteilen der Spalten in einzelne Matrizen zur Erstellung von Untermatritzen

x_data_Komponente_K1DI1 <- data_Komponente_K1DI1%>%
  select(ID_Motor.x,Produktionsdatum.x,Herstellernummer.x,Werksnummer.x)%>%
  filter(between(Produktionsdatum.x, as.Date("2008-03-01"), as.Date("2012-05-11")))%>%
  rename(ID_Motor=ID_Motor.x,Produktionsdatum=Produktionsdatum.x,Herstellernummer=Herstellernummer.x,
         Werksnummer=Werksnummer.x)


y_data_Komponente_K1DI1 <- data_Komponente_K1DI1%>%
  select(ID_Motor.y,Produktionsdatum.y,Herstellernummer.y,Werksnummer.y)%>%
  filter(between(Produktionsdatum.y, as.Date("2008-03-01"), as.Date("2012-05-11")))%>%
  rename(ID_Motor=ID_Motor.y,Produktionsdatum=Produktionsdatum.y,Herstellernummer=Herstellernummer.y,
         Werksnummer=Werksnummer.y)

z_data_Komponente_K1DI1 <- data_Komponente_K1DI1%>%
  select(ID_Motor,Produktionsdatum,Herstellernummer,Werksnummer)%>%
  filter(between(Produktionsdatum, as.Date("2008-03-01"), as.Date("2012-05-11")))

xy_data_Komponente_K1DI1<- bind_rows(x_data_Komponente_K1DI1,y_data_Komponente_K1DI1)
new_data_Komponente_K1DI1<- bind_rows(xy_data_Komponente_K1DI1,z_data_Komponente_K1DI1)

rm(x_data_Komponente_K1DI1,y_data_Komponente_K1DI1,z_data_Komponente_K1DI1,xy_data_Komponente_K1DI1) # delete Zwischenspeicher

```

# Tidy Data
Now the data have to be tidy up
```{r}

new_data_bestandteile_oem1_typ11 <- data_bestandteile_oem1_typ11 %>%
  filter(grepl("K1DI1",ID_Motor,fixed=TRUE))%>% # Filter after the relevant motor for more information : https://www.rdocumentation.org/packages/dplyr/versions/0.7.8/topics/filter
  select(ID_Motor,ID_Fahrzeug) #Select relevant coulums
  

new_data_bestandteile_oem1_typ12 <- new_data_bestandteile_oem1_typ11 %>%
  filter(grepl("K1DI1",ID_Motor,fixed=TRUE))%>%
  select(ID_Motor,ID_Fahrzeug)

new_data_fahrzeug_OEM1_Typ11 <- data_fahrzeug_OEM1_Typ11 %>%
  select(ID_Fahrzeug,Produktionsdatum)%>% # select relevant columns
  filter(between(Produktionsdatum, as.Date("2008-03-01"),
                                  as.Date("2012-05-11")))# Filter after the relevant time period for more information: https://stackoverflow.com/questions/28335715/r-how-to-filter-subset-a-sequence-of-dates
  

new_data_fahrzeug_OEM1_Typ12 <- data_fahrzeug_OEM1_Typ12 %>%
  select(ID_Fahrzeug,Produktionsdatum)%>%
  filter(between(Produktionsdatum, as.Date("2008-03-01"),
                                  as.Date("2012-05-11")))

# Tidy data_Zulassung
new_data_Zulassung <- data_Zulassung %>%
  rename(ID_Fahrzeug=IDNummer)%>% # Rename column for consistency
  select(ID_Fahrzeug,Ort,Zulassung)%>% # Select relevant columns
  mutate(ID_Fahrzeug_Nummer = as.integer64(str_replace_all(ID_Fahrzeug,"-",""))) # Add ID_Fahrzueg as integer column for further calculations

```
# Creaing one Data set
```{r}
#Summarise datatset bestandteile from oem1 Typ 11/12
data_bestandteile_OEM1 <- bind_rows(new_data_bestandteile_oem1_typ11, 
                                    new_data_bestandteile_oem1_typ12)%>% # Get one date set from Type 11 and type 12
  mutate(ID_Fahrzeug_Nummer= as.integer64(str_replace_all(ID_Fahrzeug,"-","")))# Get integer value for later join

#Summarise datatset Fahrzeug from oem1 Typ 11/12
data_fahrzeug_OEM1 <- bind_rows(new_data_fahrzeug_OEM1_Typ11,
                                new_data_fahrzeug_OEM1_Typ12)%>% # Get one date set from Type 11 and type 12
  mutate(ID_Fahrzeug_Nummer= as.integer64(str_replace_all(ID_Fahrzeug,"-","")))# Get integer value for later join    

# Left or Right Join ????
# One data set for OEM
data_OEM <- left_join(data_bestandteile_OEM1,data_fahrzeug_OEM1,
                       by="ID_Fahrzeug_Nummer",na_matches="never")%>%# Get Dataset to get engine and production date. Dealing with NA see: https://stackoverflow.com/questions/58454706/how-do-i-fix-error-stdbad-alloc-message-when-using-dplyr-full-join-to-join-3
            rename(ID_Fahrzeug = ID_Fahrzeug.x)
data_OEM$ID_Fahrzeug.y <- NULL

# Left or Right Join ????
# One data set for location
data_Ort2 <- left_join(data_Geodaten_Gemeinden,data_bundesland_plz_ort, by="PLZ")%>%
  rename(Ort=Ort.x)%>%
  distinct(Ort, .keep_all=TRUE)
data_Ort2$Ort.y <- NULL

data_Ort <- left_join(new_data_Zulassung,data_Ort2, by="Ort")

# get final dataset by joining location and OEM data set
final_data_Group_50 <- left_join(data_OEM,data_Ort,by="ID_Fahrzeug_Nummer")%>%# Joining cars with Zulassung
  rename(ID_Fahrzeug = ID_Fahrzeug.x)
final_data_Group_50$ID_Fahrzeug.y <- NULL

```

